<!DOCTYPE html>
<html>
<head>
    <title>AG2 AutoPattern Chat Interface</title>
</head>
<body>
    <h1>AG2 AutoPattern Chat Interface</h1>
    
    <div id="contextVariables">
        Context variables: which_agent: loading...
    </div>
    
    <div>
        <input type="text" id="messageInput" placeholder="Type your message" style="width: 400px;" onkeypress="handleKeyPress(event)">
        <button onclick="sendMessage()">Send</button>
    </div>
    
    <div id="messages" style="border: 1px solid #333; height: 400px; overflow-y: scroll; padding: 15px; margin-top: 10px; background: #f8f9fa; font-family: 'Consolas', monospace; line-height: 1.5;">
    </div>

    <style>
        .event-text { color: #28a745; font-weight: bold; }
        .event-group_chat_run_chat { color: #007bff; }
        .event-using_auto_reply { color: #6c757d; font-size: 0.9em; }
        .event-input_request { color: #dc3545; font-weight: bold; }
        .event-waiting_for_input { color: #fd7e14; font-weight: bold; background: #fff3cd; padding: 5px; border-radius: 3px; }
        .event-tool_call { color: #8e44ad; font-weight: bold; background: #f4e8f7; padding: 5px; border-radius: 3px; }
        .event-execute_function { color: #2c3e50; background: #ecf0f1; padding: 5px; border-radius: 3px; }
        .event-executed_function { color: #27ae60; font-weight: bold; background: #d5f4e6; padding: 5px; border-radius: 3px; }
        .event-tool_response { color: #3498db; background: #ebf3fd; padding: 5px; border-radius: 3px; }
        .timestamp { color: #6c757d; font-size: 0.85em; }
        .sender { color: #495057; font-weight: bold; }
        .uuid { color: #adb5bd; font-size: 0.8em; }
        .content { margin-left: 20px; padding: 5px; background: white; border-left: 3px solid #e9ecef; }
        .user-message { background: #e3f2fd; border-left-color: #2196f3; }
        .agent-message { background: #f3e5f5; border-left-color: #9c27b0; }
    </style>

    <script>
        let chatActive = false;
        let waitingForInput = false;

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function sendMessage() {
            const message = document.getElementById('messageInput').value;
            if (!message) return;

            if (!chatActive) {
                startChat(message);
            } else if (waitingForInput) {
                sendInput(message);
            }
            
            document.getElementById('messageInput').value = '';
        }

        function startChat(message) {
            chatActive = true;
            
            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    messages: [{ role: 'user', content: message }]
                })
            }).then(response => {
                const reader = response.body.getReader();
                
                function readStream() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            chatActive = false;
                            waitingForInput = false;
                            return;
                        }
                        
                        const chunk = new TextDecoder().decode(value);
                        const lines = chunk.split('\n');
                        
                        lines.forEach(line => {
                            if (line.startsWith('data: ')) {
                                const data = line.substring(6);
                                if (data.trim()) {
                                    const event = JSON.parse(data);
                                    
                                    if (event.type === 'context_variables') {
                                        updateContextVariables(event.content);
                                    } else {
                                        addFormattedEvent(event);
                                        
                                        if (event.type === 'waiting_for_input') {
                                            waitingForInput = true;
                                            addMessage('<div class="event-waiting_for_input">üîÑ WAITING FOR YOUR RESPONSE...</div>');
                                        }
                                    }
                                }
                            }
                        });
                        
                        readStream();
                    });
                }
                
                readStream();
            });
        }

        function sendInput(input) {
            waitingForInput = false;
            
            fetch('/send_input', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: input
                })
            }).then(response => response.json())
              .then(data => {
                  addMessage(`<div class="content user-message">‚úÖ <strong>Your response:</strong> ${input}</div>`);
              });
        }

        function addFormattedEvent(event) {
            const messagesDiv = document.getElementById('messages');
            const timestamp = new Date().toLocaleTimeString();
            let formattedMessage = '';

            switch(event.type) {
                case 'text':
                    const senderInfo = extractSenderRecipient(event.content);
                    const isUser = senderInfo.sender === 'user';
                    const contentClass = isUser ? 'user-message' : 'agent-message';
                    const icon = isUser ? 'üë§' : 'ü§ñ';
                    
                    formattedMessage = `
                        <div style="margin: 10px 0;">
                            <div class="timestamp">[${timestamp}]</div>
                            <div class="event-text">${icon} <strong>${senderInfo.sender}</strong> ‚Üí ${senderInfo.recipient}</div>
                            <div class="content ${contentClass}">${senderInfo.content}</div>
                        </div>`;
                    break;
                
                case 'group_chat_run_chat':
                    formattedMessage = `
                        <div class="event-group_chat_run_chat">
                            <span class="timestamp">[${timestamp}]</span> 
                            üîÑ <strong>Starting conversation</strong> - Active agent: <em>${extractSpeaker(event.content)}</em>
                        </div>`;
                    break;
                
                case 'using_auto_reply':
                    formattedMessage = `
                        <div class="event-using_auto_reply">
                            <span class="timestamp">[${timestamp}]</span> 
                            ‚ö° Auto-reply activated
                        </div>`;
                    break;
                
                case 'input_request':
                    formattedMessage = `
                        <div class="event-input_request">
                            <span class="timestamp">[${timestamp}]</span> 
                            ‚ùì <strong>Input request</strong>
                        </div>`;
                    break;
                
                case 'tool_call':
                    const toolCallInfo = extractToolCallInfo(event.content);
                    formattedMessage = `
                        <div class="event-tool_call">
                            <span class="timestamp">[${timestamp}]</span> 
                            üîß <strong>Tool Call:</strong> ${toolCallInfo.function_name}(${toolCallInfo.arguments})
                        </div>`;
                    break;
                
                case 'execute_function':
                    formattedMessage = `
                        <div class="event-execute_function">
                            <span class="timestamp">[${timestamp}]</span> 
                            ‚ö° <strong>Executing:</strong> ${event.content}
                        </div>`;
                    break;
                
                case 'executed_function':
                    formattedMessage = `
                        <div class="event-executed_function">
                            <span class="timestamp">[${timestamp}]</span> 
                            ‚úÖ <strong>Tool Executed:</strong> ${event.content}
                        </div>`;
                    break;
                
                case 'tool_response':
                    formattedMessage = `
                        <div class="event-tool_response">
                            <span class="timestamp">[${timestamp}]</span> 
                            üì§ <strong>Tool Response:</strong> ${event.content}
                        </div>`;
                    break;
                
                default:
                    formattedMessage = `
                        <div>
                            <span class="timestamp">[${timestamp}]</span> 
                            üìã <strong>${event.type}</strong>: ${event.content || 'No content'}
                        </div>`;
            }

            messagesDiv.innerHTML += formattedMessage;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function extractSenderRecipient(content) {
            if (!content) return { sender: 'unknown', recipient: 'unknown', content: '' };
            
            const senderMatch = content.match(/sender='([^']+)'/);
            const recipientMatch = content.match(/recipient='([^']+)'/);
            const contentMatch = content.match(/content='([^']+)'/);
            
            return {
                sender: senderMatch ? senderMatch[1] : 'unknown',
                recipient: recipientMatch ? recipientMatch[1] : 'unknown',
                content: contentMatch ? contentMatch[1] : content
            };
        }

        function extractSpeaker(content) {
            const speakerMatch = content.match(/speaker='([^']+)'/);
            return speakerMatch ? speakerMatch[1] : 'unknown';
        }

        function extractToolCallInfo(content) {
            if (!content) return { function_name: 'unknown', arguments: '' };
            
            // Extract function name from tool_calls
            const funcMatch = content.match(/function=FunctionCall\(name='([^']+)'/);
            const argsMatch = content.match(/arguments='([^']+)'/);
            
            return {
                function_name: funcMatch ? funcMatch[1] : 'unknown',
                arguments: argsMatch ? argsMatch[1] : ''
            };
        }

        function updateContextVariables(contextData) {
            const contextDiv = document.getElementById('contextVariables');
            let contextText = 'Context variables: ';
            
            for (const [key, value] of Object.entries(contextData)) {
                contextText += `${key}: ${value} `;
            }
            
            contextDiv.textContent = contextText;
        }

        function addMessage(message) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${message}</div>`;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    </script>
</body>
</html>